{% extends 'layouts/blank.html' %}

{% block content %}

<wrapper class="block max-w-2xl mx-auto my-10 px-0">
    <div id="chat_window" class="h-[1rem]10 flex flex-col bg-gray-200 rounded-2xl shadow-2xl relative p-1 sticky top-0 z-10 " style="padding-bottom: 60px; background-color: rgb(26, 23, 28);">
        <div class="flex  text-emerald-400 bg-gray-200 p-2 sticky top-10 z-10" style="position: fixed; width: 100%; top: -10%;">
            {% if other_user %}

            <a href="">
                <div class="flex items-center gap-2 p-4 sticky top- z-10">
                    <img class="w-10 h-10 rounded-full object-cover" src="{{ other_user.profile.avatar }}" />
                    <div> 
                        
                        <span class="font-bold text-white">{{ other_user.profile.name }}</span> 
                        <span class="text-sm font-light text-gray-400">@{{ other_user.username }}</span>
                    </div>
                </div>
            </a>

            {% else %}
            <div style="height: px; width: 300px;" class="bg-gray-800"> </div>
            <span id="online-count"  class="pr-1">3</span>online
            {% endif %}
        </div>

        <div id='chat_container' class="overflow-y-auto grow">
            <ul id='chat_messages' class="flex flex-col justify-end gap-2 p-1">
                {% for message in chat_messages reversed %}
                {% include 'a_rtchat/chat_message.html' %}
                {% endfor %}
            </ul>
        </div>


        <div class="sticky bottom-0 z-9 p-0 bg-gray-800 h-[6rem] " style="position: fixed; right: 0%; left: 0%; " >
            <div class="flex items-center rounded-xl px-2 py2" id="responsiveDiv" style="position: relative; right:2%;top: 20%;  ">
                <form id="chat_message_form" class="w-full" style="font-size: 20px; position: relative; left: 3%; width: 82%;" onsubmit="handleSubmit(event)"
                hx-ext="ws"
                ws-connect="/ws/chatroom/{{ chatroom_name }}"
                hx-trigger="submit" 
                hx-swap="none"
                onsubmit="keepFocus(event)"
                ws-send
                _="on htmx:wsAfterSend reset() me" >
                {% csrf_token%}
                {{form}}
               
                <button  type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-full text-sm p-2.5 text-center inline-flex items-center me-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                style="position: absolute;right: -25%;top: 0; height: 60px; z-index: 100;">
                    <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
                    </svg>
                    <span class="sr-only">Icon description</span>
                    </button>
    
                
                </form>
        
        

            </div>





            

        </div>
    </div>
</wrapper>

{% endblock %}


{% block javascript %}
<script>

const observer = new MutationObserver(() => {
        window.scrollTo({
            top: document.body.scrollHeight,
            behavior: 'smooth' // Smooth scrolling effect
        });
    });

    // Observe changes in the body
    observer.observe(document.body, { childList: true, subtree: true });


    function handleSubmit(event) {
    event.preventDefault();
    // Add your submit logic here
    console.log('Form submitted without closing the keyboard');
  }
   


  function keepFocus(event) {
    event.preventDefault(); // Prevent default form submission behavior

    // Refocus the input field to keep the keyboard open
    const inputField = document.querySelector('#chat_message_form input[type="text"]');
    if (inputField) {
        setTimeout(() => inputField.focus(), 0);
    }

    // Optionally send the form using HTMX
    htmx.trigger("#chat_message_form", "submit");
}

// Add event listener to ensure keyboard stays open
    document.addEventListener("DOMContentLoaded", () => {
        const chatForm = document.getElementById('chat_message_form');
        if (chatForm) {
            chatForm.addEventListener('submit', keepFocus);
        }
    });




</script>
{% endblock %}



